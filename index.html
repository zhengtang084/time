<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>åšè°ˆå½±åƒæ¡£æ¡ˆåº“ ChinaTime V54-Full</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        :root { --primary-color: #ff4b4b; --sidebar-bg: #1e1e2e; }
        body { font-family: "Segoe UI", "Microsoft YaHei", sans-serif; background-color: #f4f4f9; margin: 0; display: flex; }
        
        /* ä¾§è¾¹æ  */
        #sidebar { width: 300px; background: var(--sidebar-bg); color: white; height: 100vh; position: fixed; padding: 25px; box-sizing: border-box; overflow-y: auto; z-index: 100; box-shadow: 4px 0 10px rgba(0,0,0,0.2); }
        .sidebar-item { margin-bottom: 25px; }
        label { display: block; margin-bottom: 8px; font-size: 14px; color: #bbb; }
        
        /* ä¸»å†…å®¹ */
        #main-content { margin-left: 300px; padding: 40px; width: calc(100% - 300px); min-height: 100vh; }
        .stats-card { background: rgba(255,255,255,0.05); padding: 15px; border-radius: 10px; text-align: center; margin: 15px 0; }
        #total-count { font-size: 28px; font-weight: bold; color: var(--primary-color); display: block; }

        /* UI ç»„ä»¶ */
        select, input, .slider { width: 100%; padding: 10px; border-radius: 8px; border: none; margin-bottom: 10px; box-sizing: border-box; font-size: 14px; }
        .slider { cursor: pointer; accent-color: var(--primary-color); }
        .radio-group { display: flex; flex-direction: column; gap: 8px; }
        .radio-item { cursor: pointer; padding: 10px; border-radius: 6px; background: rgba(255,255,255,0.08); font-size: 13px; transition: 0.2s; border: 1px solid transparent; }
        .radio-item:hover { background: rgba(255,255,255,0.15); }
        .radio-item.active { background: var(--primary-color); color: white; border-color: var(--primary-color); }

        /* å½±åƒå±•ç¤º */
        .gallery { display: grid; gap: 20px; transition: 0.3s ease; }
        .card { background: white; border-radius: 12px; overflow: hidden; box-shadow: 0 4px 15px rgba(0,0,0,0.05); }
        .card img { width: 100%; height: 200px; object-fit: cover; background: #eee; border-bottom: 1px solid #eee; }
        .card-info { padding: 15px; }
        .card-date { color: var(--primary-color); font-weight: bold; font-size: 12px; margin-bottom: 5px; display: block; }
        .card-desc { font-size: 13px; color: #555; display: -webkit-box; -webkit-line-clamp: 3; -webkit-box-orient: vertical; overflow: hidden; line-height: 1.5; }

        #load-more { display: block; margin: 50px auto; padding: 12px 45px; background: var(--primary-color); color: white; border: none; border-radius: 30px; cursor: pointer; font-weight: bold; font-size: 16px; box-shadow: 0 4px 15px rgba(255,75,75,0.3); }
        #load-more:disabled { background: #ccc; box-shadow: none; cursor: not-allowed; }
        
        hr { border: 0; border-top: 1px solid rgba(255,255,255,0.1); margin: 20px 0; }
    </style>
</head>
<body>

<div id="sidebar">
    <h2 id="ui-title">ğŸ® å½±åƒé¦†æ§åˆ¶å°</h2>
    
    <div class="sidebar-item">
        <label id="ui-lang-label">ğŸŒ è¯­è¨€åˆ‡æ¢</label>
        <select id="lang-select"></select>
    </div>

    <div id="ui-flags" style="font-size: 18px; margin-bottom: 20px; letter-spacing: 5px;"></div>

    <div class="stats-card">
        <span id="ui-stats-label">ğŸ“Š å…¨é¦†å½±åƒæ€»è®¡</span>
        <span id="total-count">...</span>
        <small id="ui-unit">å·</small>
    </div>

    <hr>

    <div class="sidebar-item">
        <label id="ui-cat-label">ğŸ“‚ æ ç›®ç­›é€‰</label>
        <div class="radio-group" id="category-group"></div>
    </div>

    <div class="sidebar-item">
        <label id="ui-search-label">æœç´¢æ¡£æ¡ˆå†…å®¹</label>
        <input type="text" id="search-input" placeholder="è¾“å…¥å…³é”®è¯...">
    </div>

    <div class="sidebar-item">
        <label id="ui-slider-label">â³ æ—¶é—´è½´æˆªæ­¢æ—¥æœŸ</label>
        <input type="range" id="date-slider" class="slider">
        <div id="date-display" style="text-align: center; margin-top: 8px; font-weight: bold; font-family: monospace; color: var(--primary-color);"></div>
    </div>

    <div class="sidebar-item">
        <label id="ui-grid-label">ğŸ–¼ï¸ æ¯è¡Œæ˜¾ç¤ºå›¾ç‰‡æ•°</label>
        <input type="range" id="grid-slider" class="slider" min="1" max="6" value="3">
    </div>
</div>

<div id="main-content">
    <h1 id="ui-main-title">â³ å†å²å½±åƒæ—¶é—´æœºå™¨</h1>
    <div id="search-info" style="margin-bottom: 25px; color: #777; font-size: 14px; background: #fff; padding: 10px 15px; border-radius: 8px; border-left: 4px solid var(--primary-color);"></div>
    <div class="gallery" id="gallery"></div>
    <button id="load-more">ğŸ”½ åŠ è½½æ›´å¤šå½±åƒ</button>
</div>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script>
    // 1. å®Œæ•´ 10 å›½è¯­è¨€å­—å…¸ (æ ¹æ® V54 æºç å¯¹é½)
    const LANG_DICT = {
        "ğŸ‡¨ğŸ‡³ ç®€ä½“ä¸­æ–‡": { "title": "ğŸ® å½±åƒé¦†æ§åˆ¶å°", "main_title": "â³ å†å²å½±åƒæ—¶é—´æœºå™¨", "lang_label": "ğŸŒ è¯­è¨€åˆ‡æ¢", "stats_label": "ğŸ“Š å…¨é¦†å½±åƒæ€»è®¡", "unit": "å·", "total_found": "ğŸ” åœ¨ {1} ä¹‹å‰æ£€ç´¢åˆ° {0} å·å½±åƒ", "search_label": "æœç´¢æ¡£æ¡ˆå†…å®¹", "search_ph": "è¾“å…¥å…³é”®è¯...", "load_more": "ğŸ”½ åŠ è½½æ›´å¤šå½±åƒ ({0}/{1})", "no_more": "âœ… å·²æ˜¾ç¤ºå…¨éƒ¨å†…å®¹", "slider": "â³ æ—¶é—´è½´æˆªæ­¢æ—¥æœŸ", "cat_label": "ğŸ“‚ æ ç›®ç­›é€‰", "all": "å…¨éƒ¨", "no_data": "ğŸ“­ æš‚æ— å½±åƒ", "grid_label": "ğŸ–¼ï¸ æ¯è¡Œæ˜¾ç¤ºå›¾ç‰‡æ•°", "flags": "ğŸ‡¨ğŸ‡³ ğŸ‡­ğŸ‡° ğŸ‡¹ğŸ‡­ ğŸ‡®ğŸ‡· ğŸ‡ºğŸ‡¸ ğŸ‡¯ğŸ‡µ ğŸ‡°ğŸ‡· ğŸ‡©ğŸ‡ª ğŸ‡«ğŸ‡· ğŸ‡»ğŸ‡³", "cats": ["å…¨éƒ¨", "å¾®åšè°ˆ", "å¾®è§†é‡", "å¾®å†å²"] },
        "ğŸ‡­ğŸ‡° ç¹é«”ä¸­æ–‡": { "title": "ğŸ® å½±åƒé¤¨æ§åˆ¶å°", "main_title": "â³ æ­·å²å½±åƒæ™‚é–“æ©Ÿå™¨", "lang_label": "ğŸŒ èªè¨€åˆ‡æ›", "stats_label": "ğŸ“Š å…¨é¤¨å½±åƒç¸½è¨ˆ", "unit": "å·", "total_found": "ğŸ” åœ¨ {1} ä¹‹å‰æª¢ç´¢åˆ° {0} å·å½±åƒ", "search_label": "æœç´¢æª”æ¡ˆå…§å®¹", "search_ph": "è¼¸å…¥é—œéµè©...", "load_more": "ğŸ”½ åŠ è¼‰æ›´å¤šå½±åƒ ({0}/{1})", "no_more": "âœ… å·²é¡¯ç¤ºå…¨éƒ¨å…§å®¹", "slider": "â³ æ™‚é–“è»¸æˆªæ­¢æ—¥æœŸ", "cat_label": "ğŸ“‚ æ¬„ç›®ç¯©é¸", "all": "å…¨éƒ¨", "no_data": "ğŸ“­ æš«ç„¡å½±åƒ", "grid_label": "ğŸ–¼ï¸ æ¯è¡Œé¡¯ç¤ºåœ–ç‰‡æ•¸", "flags": "ğŸ‡­ğŸ‡° ğŸ‡¨ğŸ‡³ ğŸ‡¹ğŸ‡­ ğŸ‡®ğŸ‡· ğŸ‡ºğŸ‡¸ ğŸ‡¯ğŸ‡µ ğŸ‡°ğŸ‡· ğŸ‡©ğŸ‡ª ğŸ‡«ğŸ‡· ğŸ‡»ğŸ‡³", "cats": ["å…¨éƒ¨", "å¾®åšè«‡", "å¾®è¦–é‡", "å¾®æ­·å²"] },
        "ğŸ‡ºğŸ‡¸ English": { "title": "ğŸ® Control Panel", "main_title": "â³ Image Time Machine", "lang_label": "ğŸŒ Language", "stats_label": "ğŸ“Š Total Archives", "unit": "Items", "total_found": "ğŸ” Found {0} items before {1}", "search_label": "Search Archives", "search_ph": "Search...", "load_more": "ğŸ”½ Load More ({0}/{1})", "no_more": "âœ… All Loaded", "slider": "â³ Timeline Cutoff", "cat_label": "ğŸ“‚ Category", "all": "All", "no_data": "ğŸ“­ No data", "grid_label": "ğŸ–¼ï¸ Column Count", "flags": "ğŸ‡ºğŸ‡¸ ğŸ‡¬ğŸ‡§ ğŸ‡¨ğŸ‡¦ ğŸ‡¦ğŸ‡º", "cats": ["All", "å¾®åšè°ˆ", "å¾®è§†é‡", "å¾®å†å²"] },
        "ğŸ‡¯ğŸ‡µ æ—¥æœ¬èª": { "title": "ğŸ® ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«", "main_title": "â³ æ­´å²æ˜ åƒã‚¿ã‚¤ãƒ ãƒã‚·ãƒ³", "lang_label": "ğŸŒ è¨€èªåˆ‡æ›¿", "stats_label": "ğŸ“Š ç·ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–æ•°", "unit": "å·»", "total_found": "ğŸ” {1} ä»¥å‰ã« {0} å·»ã®æ˜ åƒãŒè¦‹ã¤ã‹ã‚Šã¾ã—ãŸ", "search_label": "ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–æ¤œç´¢", "search_ph": "æ¤œç´¢å†…å®¹...", "load_more": "ğŸ”½ ã‚‚ã£ã¨è¦‹ã‚‹ ({0}/{1})", "no_more": "âœ… å…¨ã¦è¡¨ç¤ºæ¸ˆã¿", "slider": "â³ ã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³æœŸé™", "cat_label": "ğŸ“‚ ã‚«ãƒ†ã‚´ãƒª", "all": "ã™ã¹ã¦", "no_data": "ğŸ“­ ãƒ‡ãƒ¼ã‚¿ãªã—", "grid_label": "ğŸ–¼ï¸ è¡¨ç¤ºåˆ—æ•°", "flags": "ğŸ‡¯ğŸ‡µ", "cats": ["ã™ã¹ã¦", "å¾®åšè«‡", "å¾®è¦–é‡", "å¾®å†å²"] },
        "ğŸ‡°ğŸ‡· í•œêµ­ì–´": { "title": "ğŸ® ì œì–´íŒ", "main_title": "â³ ì—­ì‚¬ ì˜ìƒ íƒ€ì„ë¨¸ì‹ ", "lang_label": "ğŸŒ ì–¸ì–´ ë³€ê²½", "stats_label": "ğŸ“Š ì „ì²´ ì˜ìƒ í†µê³„", "unit": "ê¶Œ", "total_found": "ğŸ” {1} ì´ì „ì— {0} ê¶Œì˜ ì˜ìƒì„ ì°¾ì•˜ìŠµë‹ˆë‹¤", "search_label": "ì•„ì¹´ì´ë¸Œ ê²€ìƒ‰", "search_ph": "í‚¤ì›Œë“œ...", "load_more": "ğŸ”½ ë” ë³´ê¸° ({0}/{1})", "no_more": "âœ… ëª¨ë‘ ë¡œë“œë¨", "slider": "â³ íƒ€ì„ë¼ì¸ ë§ˆê°ì¼", "cat_label": "ğŸ“‚ ì¹´í…Œê³ ë¦¬", "all": "ì „ì²´", "no_data": "ğŸ“­ ë°ì´í„° ì—†ìŒ", "grid_label": "ğŸ–¼ï¸ ì—´ ê°œìˆ˜", "flags": "ğŸ‡°ğŸ‡·", "cats": ["ì „ì²´", "å¾®åšè«‡", "å¾®è¦–é‡", "å¾®å†å²"] },
        "ğŸ‡©ğŸ‡ª Deutsch": { "title": "ğŸ® Konsole", "main_title": "â³ Zeitmaschine", "lang_label": "ğŸŒ Sprache", "stats_label": "ğŸ“Š Gesamtarchiv", "unit": "BÃ¤nde", "total_found": "ğŸ” {0} Bilder vor {1} gefunden", "search_label": "Suche", "search_ph": "Suchen...", "load_more": "ğŸ”½ Mehr laden ({0}/{1})", "no_more": "âœ… Alles geladen", "slider": "â³ Zeitachse", "cat_label": "ğŸ“‚ Kategorie", "all": "Alle", "no_data": "ğŸ“­ Keine Daten", "grid_label": "ğŸ–¼ï¸ Spaltenanzahl", "flags": "ğŸ‡©ğŸ‡ª ğŸ‡¦ï¼´ ğŸ‡¨ï¼¨", "cats": ["Alle", "å¾®åšè°ˆ", "å¾®è§†é‡", "å¾®å†å²"] },
        "ğŸ‡«ğŸ‡· FranÃ§ais": { "title": "ğŸ® Console", "main_title": "â³ Machine Ã  remonter le temps", "lang_label": "ğŸŒ Langue", "stats_label": "ğŸ“Š Archives totales", "unit": "Volumes", "total_found": "ğŸ” {0} images trouvÃ©es avant {1}", "search_label": "Rechercher", "search_ph": "Rechercher...", "load_more": "ğŸ”½ Charger plus ({0}/{1})", "no_more": "âœ… Tout est chargÃ©", "slider": "â³ Axe du temps", "cat_label": "ğŸ“‚ CatÃ©gorie", "all": "Tout", "no_data": "ğŸ“­ Aucune donnÃ©e", "grid_label": "ğŸ–¼ï¸ Colonnes", "flags": "ğŸ‡«ğŸ‡· ğŸ‡§ğŸ‡ª ğŸ‡¨ï¼¨ ğŸ‡¨ğŸ‡¦", "cats": ["Tout", "å¾®åšè°ˆ", "å¾®è§†é‡", "å¾®å†å²"] },
        "ğŸ‡®ğŸ‡· ÙØ§Ø±Ø³ÛŒ": { "title": "ğŸ® Ú©Ù†Ø³ÙˆÙ„", "main_title": "â³ Ù…Ø§Ø´ÛŒÙ† Ø²Ù…Ø§Ù† ØªØµÙˆÛŒØ±", "lang_label": "ğŸŒ ØªØºÛŒÛŒØ± Ø²Ø¨Ø§Ù†", "stats_label": "ğŸ“Š Ú©Ù„ Ø¢Ø±Ø´ÛŒÙˆ", "unit": "Ù…ÙˆØ±Ø¯", "total_found": "ğŸ” {0} Ù…ÙˆØ±Ø¯ Ù‚Ø¨Ù„ Ø§Ø² {1} ÛŒØ§ÙØª Ø´Ø¯", "search_label": "Ø¬Ø³ØªØ¬ÙˆÛŒ Ø¢Ø±Ø´ÛŒÙˆ", "search_ph": "Ø¬Ø³ØªØ¬Ùˆ...", "load_more": "ğŸ”½ Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ø¨ÛŒØ´ØªØ± ({0}/{1})", "no_more": "âœ… Ù‡Ù…Ù‡ Ù†Ù…Ø§ÛŒØ´ Ø¯Ø§Ø¯Ù‡ Ø´Ø¯", "slider": "â³ Ù…Ø­Ø¯ÙˆØ¯ÛŒØª Ø²Ù…Ø§Ù†ÛŒ", "cat_label": "ğŸ“‚ Ø¯Ø³ØªÙ‡ Ø¨Ù†Ø¯ÛŒ", "all": "Ù‡Ù…Ù‡", "no_data": "ğŸ“­ Ø¯Ø§Ø¯Ù‡ Ø§ÛŒ ÛŒØ§ÙØª Ù†Ø´Ø¯", "grid_label": "ğŸ–¼ï¸ ØªØ¹Ø¯Ø§Ø¯ Ø³ØªÙˆÙ† Ù‡Ø§", "flags": "ğŸ‡®ğŸ‡· ğŸ‡¦ğŸ‡«", "cats": ["Ù‡Ù…Ù‡", "å¾®åšè°ˆ", "å¾®è§†é‡", "å¾®å†å²"] },
        "ğŸ‡¹ğŸ‡­ à¹„à¸—à¸¢": { "title": "ğŸ® à¹à¸œà¸‡à¸„à¸§à¸šà¸„à¸¸à¸¡", "main_title": "â³ à¹€à¸„à¸£à¸·à¹ˆà¸­à¸‡à¸¢à¹‰à¸­à¸™à¹€à¸§à¸¥à¸²à¸ à¸²à¸à¸›à¸£à¸°à¸§à¸±à¸•à¸´à¸¨à¸²à¸ªà¸•à¸£à¹Œ", "lang_label": "ğŸŒ à¹€à¸›à¸¥à¸µà¹ˆà¸¢à¸™à¸ à¸²à¸©à¸²", "stats_label": "ğŸ“Š à¸„à¸¥à¸±à¸‡à¸ à¸²à¸à¸—à¸±à¹‰à¸‡à¸«à¸¡à¸”", "unit": "à¸¡à¹‰à¸§à¸™", "total_found": "ğŸ” à¸„à¹‰à¸™à¸à¸š {0} à¸¡à¹‰à¸§à¸™à¸ à¸²à¸à¸à¹ˆà¸­à¸™ {1}", "search_label": "à¸„à¹‰à¸™à¸«à¸²à¸„à¸¥à¸±à¸‡à¸ à¸²à¸", "search_ph": "à¸à¸´à¸¡à¸à¹Œà¸„à¸³à¸„à¹‰à¸™à¸«à¸²...", "load_more": "ğŸ”½ à¹‚à¸«à¸¥à¸”à¹€à¸à¸´à¹ˆà¸¡à¹€à¸•à¸´à¸¡ ({0}/{1})", "no_more": "âœ… à¹à¸ªà¸”à¸‡à¸—à¸±à¹‰à¸‡à¸«à¸¡à¸”à¹à¸¥à¹‰à¸§", "slider": "â³ à¸à¸³à¸«à¸™à¸”à¸Šà¹ˆà¸§à¸‡à¹€à¸§à¸¥à¸²", "cat_label": "ğŸ“‚ à¸«à¸¡à¸§à¸”à¸«à¸¡à¸¹à¹ˆ", "all": "à¸—à¸±à¹‰à¸‡à¸«à¸¡à¸”", "no_data": "ğŸ“­ à¹„à¸¡à¹ˆà¸¡à¸µà¸‚à¹‰à¸­à¸¡à¸¹à¸¥", "grid_label": "ğŸ–¼ï¸ à¸ˆà¸³à¸™à¸§à¸™à¸„à¸­à¸¥à¸±à¸¡à¸™à¹Œ", "flags": "ğŸ‡¹ğŸ‡­", "cats": ["à¸—à¸±à¹‰à¸‡à¸«à¸¡à¸”", "å¾®åšè«‡", "å¾®è¦–é‡", "å¾®æ­·å²"] },
        "ğŸ‡»ğŸ‡³ Tiáº¿ng Viá»‡t": { "title": "ğŸ® Báº£ng Ä‘iá»u khiá»ƒn", "main_title": "â³ Cá»— mÃ¡y thá»i gian hÃ¬nh áº£nh", "lang_label": "ğŸŒ NgÃ´n ngá»¯", "stats_label": "ğŸ“Š Tá»•ng kho lÆ°u trá»¯", "unit": "Cuá»‘n", "total_found": "ğŸ” TÃ¬m tháº¥y {0} má»¥c trÆ°á»›c {1}", "search_label": "TÃ¬m kiáº¿m", "search_ph": "TÃ¬m kiáº¿m...", "load_more": "ğŸ”½ Táº£i thÃªm ({0}/{1})", "no_more": "âœ… ÄÃ£ táº£i háº¿t", "slider": "â³ Trá»¥c thá»i gian", "cat_label": "ğŸ“‚ Danh má»¥c", "all": "Táº¥t cáº£", "no_data": "ğŸ“­ KhÃ´ng cÃ³ dá»¯ liá»‡u", "grid_label": "ğŸ–¼ï¸ Sá»‘ cá»™t hiá»ƒn thá»‹", "flags": "ğŸ‡»ğŸ‡³", "cats": ["Táº¥t cáº£", "å¾®åšè°ˆ", "å¾®è§†é‡", "å¾®å†å²"] }
    };

    const SB_URL = "https://ztsdhjjnydrnsxgsheyb.supabase.co";
    const SB_KEY = "sb_publishable_39tYq9zt52DxihifjY_ENw_elQW0FoK";
    const mySupabase = supabase.createClient(SB_URL, SB_KEY);

    let state = {
        lang: "ğŸ‡¨ğŸ‡³ ç®€ä½“ä¸­æ–‡",
        category: "å…¨éƒ¨",
        search: "",
        dateLimit: new Date().toISOString().split('T')[0],
        grid: 3,
        page: 0,
        pageSize: 50
    };

    function initUI() {
        const langSelect = document.getElementById('lang-select');
        Object.keys(LANG_DICT).forEach(l => {
            const opt = document.createElement('option');
            opt.value = opt.innerText = l;
            langSelect.appendChild(opt);
        });

        const slider = document.getElementById('date-slider');
        slider.min = new Date("2014-02-12").getTime();
        slider.max = new Date().getTime();
        slider.value = slider.max;

        updateLanguage();
        fetchGlobalTotal();
        refreshData(true);
    }

    function updateLanguage() {
        const L = LANG_DICT[state.lang];
        document.getElementById('ui-title').innerText = L.title;
        document.getElementById('ui-main-title').innerText = L.main_title;
        document.getElementById('ui-lang-label').innerText = L.lang_label;
        document.getElementById('ui-stats-label').innerText = L.stats_label;
        document.getElementById('ui-unit').innerText = L.unit;
        document.getElementById('ui-cat-label').innerText = L.cat_label;
        document.getElementById('ui-search-label').innerText = L.search_label;
        document.getElementById('search-input').placeholder = L.search_ph;
        document.getElementById('ui-slider-label').innerText = L.slider;
        document.getElementById('ui-grid-label').innerText = L.grid_label;
        document.getElementById('ui-flags').innerText = L.flags;

        const catGroup = document.getElementById('category-group');
        catGroup.innerHTML = "";
        L.cats.forEach((c, idx) => {
            const div = document.createElement('div');
            const realCat = (idx === 0) ? "å…¨éƒ¨" : ["å¾®åšè°ˆ", "å¾®è§†é‡", "å¾®å†å²"][idx-1];
            div.className = `radio-item ${state.category === realCat ? 'active' : ''}`;
            div.innerText = c;
            div.onclick = () => {
                state.category = realCat;
                updateLanguage();
                refreshData(true);
            };
            catGroup.appendChild(div);
        });
    }

    async function fetchGlobalTotal() {
        const { count } = await mySupabase.from('botan_final').select('*', { count: 'exact', head: true });
        document.getElementById('total-count').innerText = count.toLocaleString();
    }

    async function refreshData(isNew = false) {
        if (isNew) {
            state.page = 0;
            document.getElementById('gallery').innerHTML = "";
            document.getElementById('load-more').disabled = false;
        }

        const L = LANG_DICT[state.lang];
        let query = mySupabase.from('botan_final').select('*', { count: 'exact' });

        query = query.lte('production_date', state.dateLimit);
        if (state.search) query = query.ilike('description', `%${state.search}%`);
        if (state.category !== "å…¨éƒ¨") query = query.eq('category', state.category);

        query = query.order('production_date', { ascending: false })
                     .range(state.page * state.pageSize, (state.page + 1) * state.pageSize - 1);

        const { data, count, error } = await query;
        if (error) return;

        document.getElementById('search-info').innerText = L.total_found.replace('{0}', count).replace('{1}', state.dateLimit);
        
        if (data.length > 0) {
            renderCards(data);
            const loaded = document.querySelectorAll('.card').length;
            document.getElementById('load-more').innerText = (loaded >= count) ? L.no_more : L.load_more.replace('{0}', loaded).replace('{1}', count);
            document.getElementById('load-more').disabled = (loaded >= count);
        } else if (isNew) {
            document.getElementById('gallery').innerHTML = `<p style="text-align:center; color:#999; width:100%">${L.no_data}</p>`;
            document.getElementById('load-more').innerText = L.no_more;
            document.getElementById('load-more').disabled = true;
        }
    }

    function renderCards(data) {
        const container = document.getElementById('gallery');
        data.forEach(item => {
            const card = document.createElement('div');
            card.className = 'card';
            card.innerHTML = `
                <img src="${item.image_url}" loading="lazy" onerror="this.src='https://placehold.co/400x300?text=Image+Error'">
                <div class="card-info">
                    <span class="card-date"><i class="far fa-calendar-alt"></i> ${item.production_date}</span>
                    <div class="card-desc">${item.description || ''}</div>
                </div>
            `;
            container.appendChild(card);
        });
    }

    document.getElementById('lang-select').onchange = (e) => { state.lang = e.target.value; updateLanguage(); refreshData(true); };
    document.getElementById('search-input').oninput = (e) => {
        clearTimeout(window.stimer);
        window.stimer = setTimeout(() => { state.search = e.target.value; refreshData(true); }, 500);
    };
    document.getElementById('date-slider').oninput = (e) => {
        const d = new Date(parseInt(e.target.value));
        state.dateLimit = d.toISOString().split('T')[0];
        document.getElementById('date-display').innerText = state.dateLimit;
        clearTimeout(window.dtimer);
        window.dtimer = setTimeout(() => refreshData(true), 300);
    };
    document.getElementById('grid-slider').oninput = (e) => {
        state.grid = e.target.value;
        document.getElementById('gallery').style.gridTemplateColumns = `repeat(${state.grid}, 1fr)`;
    };
    document.getElementById('load-more').onclick = () => { state.page++; refreshData(); };

    initUI();
    document.getElementById('gallery').style.gridTemplateColumns = `repeat(${state.grid}, 1fr)`;
    document.getElementById('date-display').innerText = state.dateLimit;
</script>
</body>
</html>