<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>åšè°ˆå½±åƒæ¡£æ¡ˆåº“ V75-Botan-Blue</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        :root {
            /* --- åšè°ˆç½‘é£æ ¼é…è‰² --- */
            --primary-color: #0056b3;      /* é“¾æ¥/å¼ºè°ƒè‰²ï¼šåšè°ˆæ·±è“ */
            --primary-hover: #004494;
            --accent-red: #e60000;         /* æœç´¢/é‡ç‚¹ï¼šåšè°ˆçº¢ */
            
            --sidebar-bg: #0f172a;         /* ä¾§è¾¹æ ï¼šåˆå¤œæ·±è“ */
            --sidebar-text: #f1f5f9;       /* ä¾§è¾¹æ æ–‡å­—ï¼šäº®ç™½ */
            
            --main-bg: #f3f4f6;            /* ä¸»å†…å®¹èƒŒæ™¯ï¼šæ·¡ç°è“ */
            --card-bg: #ffffff;            /* å¡ç‰‡èƒŒæ™¯ï¼šçº¯ç™½ */
            
            --text-main: #333333;          /* æ­£æ–‡ä¸»è‰²ï¼šæ·±ç° */
            --text-muted: #64748b;         /* æ¬¡è¦æ–‡å­—ï¼šè“ç° */
            --border-color: #cbd5e1;       /* è¾¹æ¡†ï¼šæµ…è“ç° */
            
            --input-bg: rgba(255, 255, 255, 0.1);
        }

        /* --- æ·±è‰²æ¨¡å¼é€‚é… --- */
        @media (prefers-color-scheme: dark) {
            :root {
                --main-bg: #0b0e14;
                --card-bg: #1e293b;
                --text-main: #e2e8f0;      /* æ·±è‰²æ¨¡å¼ä¸‹ä¸»æ–‡å­—å˜äº® */
                --text-muted: #94a3b8;
                --border-color: #334155;
                /* ä¾§è¾¹æ ä¿æŒæ·±è‰²ï¼Œæ— éœ€å˜åŒ– */
            }
        }

        body { font-family: "Segoe UI", "PingFang SC", "Microsoft YaHei", sans-serif; background-color: var(--main-bg); color: var(--text-main); margin: 0; display: flex; transition: background 0.3s; }
        
        /* === ä¾§è¾¹æ è®¾è®¡ === */
        #sidebar { 
            width: 300px; 
            background: var(--sidebar-bg); 
            color: var(--sidebar-text); 
            height: 100vh; 
            position: fixed; 
            padding: 25px; 
            box-sizing: border-box; 
            overflow-y: auto; 
            z-index: 100; 
            border-right: 1px solid rgba(255,255,255,0.1);
            box-shadow: 2px 0 10px rgba(0,0,0,0.2);
        }
        
        .sidebar-item { margin-bottom: 25px; }
        
        .label-text { 
            font-size: 13px; 
            color: #94a3b8; /* ä¾§è¾¹æ æ ‡ç­¾ä¸“ç”¨è‰² */
            margin-bottom: 8px; 
            display: block; 
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        /* åŠ¨æ€é¢œè‰²æ–‡å­— (æ ‡é¢˜ã€æ—¥æœŸç­‰è·Ÿéšä¸»é¢˜) */
        .theme-text { color: var(--text-main); transition: color 0.3s; }
        
        /* ä¾§è¾¹æ æ•°å€¼é«˜äº® (å§‹ç»ˆä¸ºå¼ºè°ƒè‰²) */
        .highlight-val { color: #60a5fa; font-weight: bold; font-family: monospace; }
        
        .range-sub-info { 
            display: flex; 
            justify-content: space-between; 
            font-size: 12px; 
            color: #94a3b8; 
            margin-top: 5px; 
        }

        /* ç»Ÿè®¡å¡ç‰‡ */
        .stats-box { 
            background: rgba(255,255,255,0.05); 
            padding: 15px; 
            border-radius: 8px; 
            text-align: center; 
            margin-bottom: 25px; 
            border: 1px solid rgba(255,255,255,0.1); 
        }
        #total-count { font-size: 24px; font-weight: bold; color: #fff; display: block; margin-top: 5px; }

        /* ä¸‹æ‹‰æ¡† (æ·±è‰²èƒŒæ™¯ä¿®æ­£) */
        select { 
            width: 100%; padding: 10px; border-radius: 6px; 
            border: 1px solid rgba(255,255,255,0.2); 
            background-color: #334155 !important; /* å¼ºåˆ¶æ·±è‰²èƒŒæ™¯ */
            color: #ffffff !important;            /* å¼ºåˆ¶ç™½è‰²æ–‡å­— */
            box-sizing: border-box; outline: none; cursor: pointer;
            appearance: none;
            background-image: url("data:image/svg+xml;charset=UTF-8,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='white' width='18px' height='18px'%3E%3Cpath d='M7 10l5 5 5-5z'/%3E%3C/svg%3E");
            background-repeat: no-repeat; background-position: right 10px center;
        }

        /* æœç´¢åŒºåŸŸ */
        .search-wrapper { display: flex; gap: 8px; }
        .search-input { 
            flex: 1; padding: 10px; border-radius: 6px; 
            border: 1px solid rgba(255,255,255,0.2); 
            background: var(--input-bg); color: white; 
            box-sizing: border-box; outline: none; 
        }
        .btn-search { 
            background: var(--accent-red); /* åšè°ˆçº¢ */
            color: white; 
            border: none; 
            border-radius: 6px; 
            width: 42px; /* å›ºå®šå®½åº¦ */
            height: 42px; /* å›ºå®šé«˜åº¦ - é˜²æ­¢å˜å½¢ */
            aspect-ratio: 1/1; /* é”å®šæ¯”ä¾‹ */
            cursor: pointer; 
            display: flex; align-items: center; justify-content: center;
            transition: background 0.2s;
        }
        .btn-search:hover { background: #ff3333; }

        /* åˆ†ç±»ç­›é€‰ */
        .radio-group { display: flex; flex-direction: column; gap: 8px; }
        .radio-item { 
            cursor: pointer; padding: 10px; border-radius: 6px; 
            background: rgba(255,255,255,0.05); 
            font-size: 14px; color: #ccc; transition: 0.2s; 
        }
        .radio-item:hover { background: rgba(255,255,255,0.1); }
        .radio-item.active { 
            background: var(--primary-color); 
            color: white; 
            font-weight: bold; 
            border-left: 4px solid #60a5fa;
        }

        /* === ä¸»å†…å®¹åŒº === */
        #main-content { margin-left: 300px; padding: 40px; width: calc(100% - 300px); min-height: 100vh; }
        
        /* æ ‡é¢˜é¢œè‰²è”åŠ¨ */
        h1#ui-main-title { color: var(--text-main); border-bottom: 2px solid var(--border-color); padding-bottom: 15px; }

        .gallery { display: grid; gap: 25px; align-items: start; }

        /* æŒ‰æ—¥æœŸå½’é›†æ ‡é¢˜ (é¢œè‰²è·Ÿéšä¸»æ ‡é¢˜) */
        .date-group-header {
            grid-column: 1 / -1; /* è·¨è¶Šæ‰€æœ‰åˆ— */
            padding: 25px 0 10px 0;
            margin-top: 10px;
            font-size: 1.2rem;
            font-weight: bold;
            color: var(--text-main); /* è·Ÿéšä¸»é¢˜å˜è‰² */
            border-bottom: 2px solid var(--primary-color);
            display: flex; align-items: center; gap: 10px;
        }
        .date-group-header i { color: var(--primary-color); opacity: 0.8; }

        /* å¡ç‰‡æ ·å¼ */
        .card { 
            background: var(--card-bg); 
            border-radius: 8px; 
            overflow: hidden; 
            box-shadow: 0 2px 8px rgba(0,0,0,0.08); 
            border: 1px solid var(--border-color); 
            transition: transform 0.2s;
        }
        .card:hover { transform: translateY(-3px); box-shadow: 0 5px 15px rgba(0,0,0,0.12); }
        
        .card-img-container { 
            background: #000; 
            width: 100%; 
            aspect-ratio: 4/3; /* ç»Ÿä¸€æ¯”ä¾‹ */
            display: flex; justify-content: center; align-items: center; 
            cursor: zoom-in;
            overflow: hidden;
        }
        .card img { width: 100%; height: 100%; object-fit: contain; }
        
        .card-info { padding: 12px; }
        
        .item-date { font-size: 12px; color: var(--text-muted); font-weight: bold; }
        
        .item-title-link { 
            color: var(--primary-color); 
            text-decoration: none; 
            font-size: 14px; 
            cursor: pointer; 
            font-weight: 600; 
            display: block;
            margin-top: 4px;
        }
        .item-title-link:hover { text-decoration: underline; color: var(--primary-hover); }

        /* æè¿°æŠ˜å é¢æ¿ */
        .description-panel { 
            max-height: 0; overflow: hidden; 
            transition: max-height 0.4s ease; 
            font-size: 13px; color: var(--text-main); 
            line-height: 1.6; margin-top: 0;
            opacity: 0.9;
        }
        .description-panel.open { 
            max-height: 400px; 
            margin-top: 10px; 
            padding-top: 10px; 
            border-top: 1px dashed var(--border-color); 
        }

        /* === ç¯ç®± (Lightbox) === */
        #lightbox { 
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
            background: rgba(0,0,0,0.95); z-index: 2000; 
            flex-direction: column; justify-content: center; align-items: center; 
        }
        #lightbox-img { max-width: 90%; max-height: 75%; object-fit: contain; border: 2px solid #fff; box-shadow: 0 0 20px rgba(0,0,0,0.5); }
        
        #lb-caption { 
            color: white; margin-top: 20px; 
            text-align: center; padding: 0 20px; 
            max-width: 800px; font-size: 15px; line-height: 1.5; 
        }

        /* ç¯ç®±æŒ‰é’® (é˜²å˜å½¢) */
        .lb-btn {
            position: absolute;
            background: rgba(255,255,255,0.15);
            color: white;
            border: none;
            width: 60px; height: 60px; /* å¼ºåˆ¶æ­£æ–¹å½¢ */
            aspect-ratio: 1/1;         /* é”å®šæ¯”ä¾‹ */
            border-radius: 50%;
            font-size: 24px;
            cursor: pointer;
            display: flex; align-items: center; justify-content: center;
            transition: background 0.2s;
            z-index: 2001;
        }
        .lb-btn:hover { background: var(--primary-color); }
        
        .lb-close { top: 20px; right: 20px; }
        .lb-prev { top: 50%; left: 20px; transform: translateY(-50%); }
        .lb-next { top: 50%; right: 20px; transform: translateY(-50%); }

        /* åŠ è½½æŒ‰é’® */
        #load-more { 
            display: block; margin: 50px auto; padding: 15px 40px; 
            background: var(--primary-color); color: white; 
            border: none; border-radius: 30px; 
            cursor: pointer; font-weight: bold; font-size: 14px;
            transition: opacity 0.3s;
        }
        #load-more:disabled { opacity: 0.6; cursor: not-allowed; background: #999; }
    </style>
</head>
<body>

<div id="sidebar">
    <h2 style="color:var(--sidebar-text); border-bottom:1px solid #333; padding-bottom:10px;">
        <i class="fas fa-archive"></i> <span id="ui-title">åšè°ˆæ¡£æ¡ˆ</span>
    </h2>
    
    <div class="sidebar-item">
        <label class="label-text" id="ui-lang-label">ğŸŒ Language</label>
        <select id="lang-select" onchange="changeLang(this.value)"></select>
    </div>

    <div class="stats-box">
        <span class="label-text" id="ui-stats-label">ğŸ“Š å½±åƒæ€»è®¡</span>
        <span id="total-count">...</span>
        <small id="ui-unit" style="color:#888">å·</small>
    </div>

    <div class="sidebar-item">
        <label class="label-text" id="ui-cat-label">ğŸ“‚ æ ç›®ç­›é€‰</label>
        <div class="radio-group" id="category-group"></div>
    </div>

    <div class="sidebar-item">
        <label class="label-text" id="ui-search-label">æœç´¢</label>
        <div class="search-wrapper">
            <input type="text" id="search-input" class="search-input" placeholder="...">
            <button class="btn-search" id="btn-search-trigger"><i class="fas fa-search"></i></button>
        </div>
    </div>
    
    <div class="sidebar-item">
        <div class="label-row">
            <span class="label-text" id="ui-slider-label">â³ æ—¶é—´è½´</span>
            <span id="date-display" class="highlight-val"></span>
        </div>
        <input type="range" id="date-slider" style="width:100%">
        <div class="range-sub-info">
            <span id="start-date-label" class="theme-text">2014-02-12</span>
            <span id="ui-date-end-label" class="theme-text">Today</span>
        </div>
    </div>

    <div class="sidebar-item">
        <div class="label-row">
            <span class="label-text" id="ui-grid-label">ğŸ–¼ï¸ ç½‘æ ¼å¸ƒå±€</span>
            <span id="grid-display" class="highlight-val">3</span>
        </div>
        <input type="range" id="grid-slider" min="1" max="6" value="3" style="width:100%">
    </div>
</div>

<div id="main-content">
    <h1 id="ui-main-title"><i class="fas fa-history"></i> å†å²å½±åƒæ—¶é—´æœºå™¨</h1>
    <div id="search-info" style="margin-bottom: 25px; color: var(--text-muted); font-size: 14px;"></div>
    
    <div class="gallery" id="gallery"></div>
    
    <button id="load-more">Loading...</button>
</div>

<div id="lightbox">
    <button class="lb-btn lb-close" onclick="closeLb()"><i class="fas fa-times"></i></button>
    <button class="lb-btn lb-prev" onclick="moveLb(-1)"><i class="fas fa-chevron-left"></i></button>
    <button class="lb-btn lb-next" onclick="moveLb(1)"><i class="fas fa-chevron-right"></i></button>
    
    <img id="lightbox-img">
    <div id="lb-caption"></div>
</div>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script>
    const todayStr = new Date().toISOString().split('T')[0];

    // å®Œæ•´ 10 å›½è¯­è¨€å­—å…¸ (æ—  undefined)
    const LANG_DICT = {
        "ğŸ‡¨ğŸ‡³ ç®€ä½“ä¸­æ–‡": { 
            "title": "åšè°ˆæ¡£æ¡ˆ", "main_title": "â³ å†å²å½±åƒæ—¶é—´æœºå™¨", "lang_label": "ğŸŒ è¯­è¨€åˆ‡æ¢", "stats_label": "ğŸ“Š å…¨é¦†å½±åƒæ€»è®¡", "unit": "å·", 
            "search_info": "ğŸ” åœ¨ {1} ä¹‹å‰æ£€ç´¢åˆ° {0} å·å½±åƒ", "search_label": "æœç´¢æ¡£æ¡ˆå†…å®¹", "cat_label": "ğŸ“‚ æ ç›®ç­›é€‰", "slider_label": "â³ æ—¶é—´è½´", 
            "grid_label": "ğŸ–¼ï¸ ç½‘æ ¼åˆ—æ•°", "col_unit": "åˆ—", "load_more": "å½“å‰å·²åŠ è½½ {0} å¼  / åç»­æœç´¢åˆ° {1} å¼ ", "no_more": "âœ… å·²æ˜¾ç¤ºå…¨éƒ¨ {0} å¼ å½±åƒ", 
            "cats": ["å…¨éƒ¨", "å¾®åšè°ˆ", "å¾®å†å²", "å¾®è§†é‡"], "date_end": "ä»Š" 
        },
        "ğŸ‡­ğŸ‡° ç¹é«”ä¸­æ–‡": { 
            "title": "åšè«‡æª”æ¡ˆ", "main_title": "â³ æ­·å²å½±åƒæ™‚é–“æ©Ÿå™¨", "lang_label": "ğŸŒ èªè¨€åˆ‡æ›", "stats_label": "ğŸ“Š å…¨é¤¨å½±åƒç¸½è¨ˆ", "unit": "å·", 
            "search_info": "ğŸ” åœ¨ {1} ä¹‹å‰æª¢ç´¢åˆ° {0} å·å½±åƒ", "search_label": "æœç´¢æª”æ¡ˆå…§å®¹", "cat_label": "ğŸ“‚ æ¬„ç›®ç¯©é¸", "slider_label": "â³ æ™‚é–“è»¸", 
            "grid_label": "ğŸ–¼ï¸ ç¶²æ ¼åˆ—æ•¸", "col_unit": "åˆ—", "load_more": "ç•¶å‰å·²åŠ è¼‰ {0} å¼µ / å¾ŒçºŒæœç´¢åˆ° {1} å¼µ", "no_more": "âœ… å·²é¡¯ç¤ºå…¨éƒ¨ {0} å¼µå½±åƒ", 
            "cats": ["å…¨éƒ¨", "å¾®åšè«‡", "å¾®æ­·å²", "å¾®è¦–é‡"], "date_end": "ä»Š" 
        },
        "ğŸ‡ºğŸ‡¸ English": { 
            "title": "Botan Archive", "main_title": "â³ History Time Machine", "lang_label": "ğŸŒ Language", "stats_label": "ğŸ“Š Total Records", "unit": "Items", 
            "search_info": "ğŸ” Found {0} items before {1}", "search_label": "Search Content", "cat_label": "ğŸ“‚ Categories", "slider_label": "â³ Timeline", 
            "grid_label": "ğŸ–¼ï¸ Grid Columns", "col_unit": "Cols", "load_more": "Loaded {0} / Total Search {1}", "no_more": "âœ… All {0} items displayed", 
            "cats": ["All", "Weibo", "History", "Vision"], "date_end": "Now" 
        },
        "ğŸ‡¯ğŸ‡µ æ—¥æœ¬èª": { "title": "Botanã‚¢ãƒ¼ã‚«ã‚¤ãƒ–", "main_title": "â³ æ­´å²ã‚¿ã‚¤ãƒ ãƒã‚·ãƒ³", "lang_label": "ğŸŒ è¨€èª", "stats_label": "ğŸ“Š ç·è¨˜éŒ²æ•°", "unit": "ä»¶", "search_info": "ğŸ” {1} ä»¥å‰ã« {0} ä»¶è¦‹ã¤ã‹ã‚Šã¾ã—ãŸ", "search_label": "æ¤œç´¢", "cat_label": "ğŸ“‚ ã‚«ãƒ†ã‚´ãƒª", "slider_label": "â³ å¹´è¡¨", "grid_label": "ğŸ–¼ï¸ åˆ—æ•°", "col_unit": "åˆ—", "load_more": "{0} ä»¶è¡¨ç¤ºä¸­ / åˆè¨ˆ {1} ä»¶", "no_more": "âœ… å…¨ {0} ä»¶ã‚’è¡¨ç¤ºã—ã¾ã—ãŸ", "cats": ["ã™ã¹ã¦", "å¾®åšè«‡", "å¾®æ­´å²", "å¾®è¦–é‡"], "date_end": "ç¾åœ¨" },
        "ğŸ‡°ğŸ‡· í•œêµ­ì–´": { "title": "Botan ì•„ì¹´ì´ë¸Œ", "main_title": "â³ ì—­ì‚¬ íƒ€ì„ë¨¸ì‹ ", "lang_label": "ğŸŒ ì–¸ì–´", "stats_label": "ğŸ“Š ì´ ê¸°ë¡", "unit": "ê±´", "search_info": "ğŸ” {1} ì´ì „ì— {0} ê±´ ë°œê²¬", "search_label": "ê²€ìƒ‰", "cat_label": "ğŸ“‚ ì¹´í…Œê³ ë¦¬", "slider_label": "â³ íƒ€ì„ë¼ì¸", "grid_label": "ğŸ–¼ï¸ ê·¸ë¦¬ë“œ ì—´", "col_unit": "ì—´", "load_more": "{0} ë¡œë“œë¨ / ì´ {1}", "no_more": "âœ… ì „ì²´ {0} í‘œì‹œë¨", "cats": ["ì „ì²´", "å¾®åšè«‡", "å¾®æ­·å²", "å¾®è¦–é‡"], "date_end": "í˜„ì¬" },
        "ğŸ‡©ğŸ‡ª Deutsch": { "title": "Botan Archiv", "main_title": "â³ Zeitmaschine", "lang_label": "ğŸŒ Sprache", "stats_label": "ğŸ“Š Gesamt", "unit": "Artikel", "search_info": "ğŸ” {0} Ergebnisse vor {1}", "search_label": "Suche", "cat_label": "ğŸ“‚ Kategorien", "slider_label": "â³ Zeitachse", "grid_label": "ğŸ–¼ï¸ Spalten", "col_unit": "Sp.", "load_more": "{0} geladen / {1} gesamt", "no_more": "âœ… Alle {0} angezeigt", "cats": ["Alle", "Weibo", "Historie", "Vision"], "date_end": "Heute" },
        "ğŸ‡«ğŸ‡· FranÃ§ais": { "title": "Archives Botan", "main_title": "â³ Machine Ã  voyager", "lang_label": "ğŸŒ Langue", "stats_label": "ğŸ“Š Total", "unit": "Articles", "search_info": "ğŸ” {0} rÃ©sultats avant {1}", "search_label": "Chercher", "cat_label": "ğŸ“‚ CatÃ©gories", "slider_label": "â³ Chronologie", "grid_label": "ğŸ–¼ï¸ Colonnes", "col_unit": "Col.", "load_more": "{0} chargÃ©s / {1} au total", "no_more": "âœ… Tous les {0} affichÃ©s", "cats": ["Tout", "Weibo", "Histoire", "Vision"], "date_end": "Auj." },
        "ğŸ‡®ğŸ‡· ÙØ§Ø±Ø³ÛŒ": { "title": "Ø¢Ø±Ø´ÛŒÙˆ Ø¨ÙˆØªØ§Ù†", "main_title": "â³ Ù…Ø§Ø´ÛŒÙ† Ø²Ù…Ø§Ù†", "lang_label": "ğŸŒ Ø²Ø¨Ø§Ù†", "stats_label": "ğŸ“Š Ù…Ø¬Ù…ÙˆØ¹", "unit": "Ù…ÙˆØ±Ø¯", "search_info": "ğŸ” {0} Ù…ÙˆØ±Ø¯ Ù‚Ø¨Ù„ Ø§Ø² {1}", "search_label": "Ø¬Ø³ØªØ¬Ùˆ", "cat_label": "ğŸ“‚ Ø¯Ø³ØªÙ‡â€ŒÙ‡Ø§", "slider_label": "â³ Ø®Ø· Ø²Ù…Ø§Ù†ÛŒ", "grid_label": "ğŸ–¼ï¸ Ø³ØªÙˆÙ†â€ŒÙ‡Ø§", "col_unit": "Ø³Øª.", "load_more": "{0} Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ø´Ø¯ / {1} Ú©Ù„", "no_more": "âœ… Ù‡Ù…Ù‡ {0} Ù†Ù…Ø§ÛŒØ´ Ø¯Ø§Ø¯Ù‡ Ø´Ø¯", "cats": ["Ù‡Ù…Ù‡", "ÙˆÛŒØ¨Ùˆ", "ØªØ§Ø±ÛŒØ®", "Ø¯ÛŒØ¯Ú¯Ø§Ù‡"], "date_end": "Ø§Ú©Ù†ÙˆÙ†" },
        "ğŸ‡¹ğŸ‡­ à¹„à¸—à¸¢": { "title": "à¸„à¸¥à¸±à¸‡à¸‚à¹‰à¸­à¸¡à¸¹à¸¥ Botan", "main_title": "â³ à¹„à¸—à¸¡à¹Œà¹à¸¡à¸Šà¸Šà¸µà¸™", "lang_label": "ğŸŒ à¸ à¸²à¸©à¸²", "stats_label": "ğŸ“Š à¸—à¸±à¹‰à¸‡à¸«à¸¡à¸”", "unit": "à¸£à¸²à¸¢à¸à¸²à¸£", "search_info": "ğŸ” à¸à¸š {0} à¸£à¸²à¸¢à¸à¸²à¸£à¸à¹ˆà¸­à¸™ {1}", "search_label": "à¸„à¹‰à¸™à¸«à¸²", "cat_label": "ğŸ“‚ à¸«à¸¡à¸§à¸”à¸«à¸¡à¸¹à¹ˆ", "slider_label": "â³ à¹„à¸—à¸¡à¹Œà¹„à¸¥à¸™à¹Œ", "grid_label": "ğŸ–¼ï¸ à¸„à¸­à¸¥à¸±à¸¡à¸™à¹Œ", "col_unit": "à¸„à¸­à¸¥à¸±à¸¡à¸™à¹Œ", "load_more": "à¹‚à¸«à¸¥à¸” {0} / à¸—à¸±à¹‰à¸‡à¸«à¸¡à¸” {1}", "no_more": "âœ… à¹à¸ªà¸”à¸‡à¸„à¸£à¸š {0} à¸£à¸²à¸¢à¸à¸²à¸£", "cats": ["à¸—à¸±à¹‰à¸‡à¸«à¸¡à¸”", "Weibo", "à¸›à¸£à¸°à¸§à¸±à¸•à¸´à¸¨à¸²à¸ªà¸•à¸£à¹Œ", "à¸§à¸´à¸ªà¸±à¸¢à¸—à¸±à¸¨à¸™à¹Œ"], "date_end": "à¸§à¸±à¸™à¸™à¸µà¹‰" },
        "ğŸ‡»ğŸ‡³ Tiáº¿ng Viá»‡t": { "title": "LÆ°u trá»¯ Botan", "main_title": "â³ Cá»— mÃ¡y thá»i gian", "lang_label": "ğŸŒ NgÃ´n ngá»¯", "stats_label": "ğŸ“Š Tá»•ng sá»‘", "unit": "Má»¥c", "search_info": "ğŸ” TÃ¬m tháº¥y {0} má»¥c trÆ°á»›c {1}", "search_label": "TÃ¬m kiáº¿m", "cat_label": "ğŸ“‚ Danh má»¥c", "slider_label": "â³ DÃ²ng thá»i gian", "grid_label": "ğŸ–¼ï¸ Cá»™t", "col_unit": "Cá»™t", "load_more": "ÄÃ£ táº£i {0} / Tá»•ng {1}", "no_more": "âœ… ÄÃ£ hiá»‡n táº¥t cáº£ {0}", "cats": ["Táº¥t cáº£", "Weibo", "Lá»‹ch sá»­", "Táº§m nhÃ¬n"], "date_end": "HÃ´m nay" }
    };

    const SB_URL = "https://ztsdhjjnydrnsxgsheyb.supabase.co";
    const SB_KEY = "sb_publishable_39tYq9zt52DxihifjY_ENw_elQW0FoK";
    const mySupabase = supabase.createClient(SB_URL, SB_KEY);

    let state = { 
        lang: "ğŸ‡¨ğŸ‡³ ç®€ä½“ä¸­æ–‡", 
        category: "å…¨éƒ¨", 
        search: "", 
        dateLimit: todayStr, 
        grid: 3, 
        page: 0, 
        pageSize: 50, 
        allImages: [], 
        currentLbIdx: 0, 
        lastDate: null, 
        totalSearchCount: 0 
    };

    async function initUI() {
        const langSelect = document.getElementById('lang-select');
        Object.keys(LANG_DICT).forEach(l => {
            const opt = document.createElement('option');
            opt.value = opt.innerText = l;
            langSelect.appendChild(opt);
        });

        const slider = document.getElementById('date-slider');
        slider.min = new Date("2014-02-12").getTime();
        slider.max = new Date().getTime();
        slider.value = slider.max;
        document.getElementById('date-display').innerText = state.dateLimit;

        updateLanguage();
        await fetchGlobalTotal(); 
        refreshData(true);
    }

    function changeLang(val) { state.lang = val; updateLanguage(); updateLoadMoreUI(); }

    function updateLanguage() {
        const L = LANG_DICT[state.lang] || LANG_DICT["ğŸ‡¨ğŸ‡³ ç®€ä½“ä¸­æ–‡"];
        document.getElementById('ui-title').innerText = L.title;
        document.getElementById('ui-main-title').innerHTML = `<i class="fas fa-history"></i> ${L.main_title}`;
        document.getElementById('ui-lang-label').innerText = L.lang_label;
        document.getElementById('ui-stats-label').innerText = L.stats_label;
        document.getElementById('ui-unit').innerText = L.unit;
        document.getElementById('ui-cat-label').innerText = L.cat_label;
        document.getElementById('ui-search-label').innerText = L.search_label;
        document.getElementById('ui-slider-label').innerText = L.slider_label;
        document.getElementById('ui-grid-label').innerText = L.grid_label;
        document.getElementById('grid-display').innerText = `${state.grid} ${L.col_unit}`;
        document.getElementById('ui-date-end-label').innerText = L.date_end;

        const catGroup = document.getElementById('category-group');
        catGroup.innerHTML = "";
        L.cats.forEach((c, idx) => {
            const dbCatsMap = ["å…¨éƒ¨", "å¾®åšè°ˆ", "å¾®å†å²", "å¾®è§†é‡"];
            const realCat = dbCatsMap[idx];
            const div = document.createElement('div');
            div.className = `radio-item ${state.category === realCat ? 'active' : ''}`;
            div.innerText = c;
            div.onclick = () => { state.category = realCat; updateLanguage(); refreshData(true); };
            catGroup.appendChild(div);
        });
    }

    async function fetchGlobalTotal() {
        const { count } = await mySupabase.from('botan_final').select('*', { count: 'exact', head: true });
        document.getElementById('total-count').innerText = count ? count.toLocaleString() : "0";
    }

    async function refreshData(isNew = false) {
        if (isNew) { state.page = 0; state.allImages = []; state.lastDate = null; document.getElementById('gallery').innerHTML = ""; }
        const L = LANG_DICT[state.lang];
        
        let query = mySupabase.from('botan_final').select('*', { count: 'exact' });
        query = query.lte('production_date', state.dateLimit);
        if (state.search) query = query.ilike('description', `%${state.search}%`);
        if (state.category !== "å…¨éƒ¨") query = query.eq('category', state.category);
        query = query.order('production_date', { ascending: false }).range(state.page * state.pageSize, (state.page + 1) * state.pageSize - 1);

        const { data, count, error } = await query;
        if (error || !data) return;

        state.totalSearchCount = count;
        document.getElementById('search-info').innerText = L.search_info.replace('{0}', count.toLocaleString()).replace('{1}', state.dateLimit);
        
        state.allImages = state.allImages.concat(data);
        renderCards(data);
        updateLoadMoreUI();
    }

    function updateLoadMoreUI() {
        const L = LANG_DICT[state.lang];
        const btn = document.getElementById('load-more');
        if (state.allImages.length >= state.totalSearchCount) {
            btn.innerText = L.no_more.replace('{0}', state.allImages.length);
            btn.disabled = true;
        } else {
            btn.innerText = L.load_more.replace('{0}', state.allImages.length).replace('{1}', state.totalSearchCount);
            btn.disabled = false;
        }
    }

    function renderCards(data) {
        const container = document.getElementById('gallery');
        container.style.gridTemplateColumns = `repeat(${state.grid}, 1fr)`;
        
        data.forEach((item) => {
            // æŒ‰æ—¥æœŸå½’é›†æ˜¾ç¤º (Title Header)
            // é¢œè‰²è·Ÿéš "å†å²å½±åƒæ—¶é—´æœºå™¨" (å³ var(--text-main))
            if (item.production_date !== state.lastDate) {
                const header = document.createElement('div');
                header.className = 'date-group-header';
                header.innerHTML = `<i class="fas fa-calendar-alt"></i> ${item.production_date}`;
                container.appendChild(header);
                state.lastDate = item.production_date;
            }

            const card = document.createElement('div');
            card.className = 'card';
            card.innerHTML = `
                <div class="card-img-container"><img src="${item.image_url}" onclick="openLbByUrl('${item.image_url}')" loading="lazy"></div>
                <div class="card-info">
                    <div style="display:flex; justify-content:space-between; align-items:center;">
                        <span class="item-date">ğŸ“… ${item.production_date}</span>
                        <a class="item-title-link" onclick="toggleDesc(this)">ğŸ”— ${item.title || 'è¯¦æƒ…å±•å¼€'}</a>
                    </div>
                    <div class="description-panel">${item.description || ''}</div>
                </div>
            `;
            container.appendChild(card);
        });
    }

    function toggleDesc(btn) { 
        btn.parentElement.nextElementSibling.classList.toggle('open'); 
    }

    // ç¯ç®±é€»è¾‘
    function openLbByUrl(url) {
        state.currentLbIdx = state.allImages.findIndex(i => i.image_url === url);
        updateLb();
        document.getElementById('lightbox').style.display = 'flex';
        document.body.style.overflow = 'hidden';
    }
    function updateLb() {
        const item = state.allImages[state.currentLbIdx];
        document.getElementById('lightbox-img').src = item.image_url;
        document.getElementById('lb-caption').innerText = item.description || '';
    }
    // å¾ªç¯æ’­æ”¾é€»è¾‘
    function moveLb(dir) {
        state.currentLbIdx = (state.currentLbIdx + dir + state.allImages.length) % state.allImages.length;
        updateLb();
    }
    function closeLb() { document.getElementById('lightbox').style.display = 'none'; document.body.style.overflow = 'auto'; }

    // æœç´¢é€»è¾‘
    function triggerSearch() { 
        state.search = document.getElementById('search-input').value; 
        refreshData(true); 
    }
    document.getElementById('btn-search-trigger').onclick = triggerSearch;
    document.getElementById('search-input').onkeydown = (e) => { if(e.key === 'Enter') triggerSearch(); };

    // ç›‘å¬å™¨
    document.getElementById('date-slider').oninput = (e) => {
        state.dateLimit = new Date(parseInt(e.target.value)).toISOString().split('T')[0];
        document.getElementById('date-display').innerText = state.dateLimit;
        clearTimeout(window.dt); window.dt = setTimeout(() => refreshData(true), 300);
    };
    document.getElementById('grid-slider').oninput = (e) => {
        state.grid = e.target.value;
        updateLanguage();
        document.getElementById('gallery').style.gridTemplateColumns = `repeat(${state.grid}, 1fr)`;
    };
    document.getElementById('load-more').onclick = () => { state.page++; refreshData(); };

    initUI();
</script>
</body>
</html>