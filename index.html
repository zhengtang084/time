<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>åšè°ˆå½±åƒæ¡£æ¡ˆåº“ V62-Final</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        /* ã€1. å®šä¹‰è‰²å½©å˜é‡ã€‘ */
        :root {
            --primary-color: #ff4b4b;
            --main-bg: #f4f4f9;
            --sidebar-bg: #1e1e2e;
            --card-bg: #ffffff;
            --text-main: #333333;
            --text-muted: #666666;
            --border-color: #eeeeee;
            --input-bg: rgba(255, 255, 255, 0.1);
            --select-text: #ffffff; /* ä¾§è¾¹æ ä¸‹æ‹‰æ¡†æ–‡å­—é¢œè‰² */
        }

        @media (prefers-color-scheme: dark) {
            :root {
                --main-bg: #121212;
                --sidebar-bg: #000000;
                --card-bg: #1e1e1e;
                --text-main: #e0e0e0;
                --text-muted: #aaaaaa;
                --border-color: #333333;
                --input-bg: rgba(255, 255, 255, 0.05);
                --select-text: #ffffff;
            }
        }

        body { 
            font-family: "Segoe UI", "Microsoft YaHei", sans-serif; 
            background-color: var(--main-bg); 
            color: var(--text-main);
            margin: 0; display: flex; 
            transition: all 0.3s ease;
        }
        
        #sidebar { 
            width: 300px; background: var(--sidebar-bg); color: white; 
            height: 100vh; position: fixed; padding: 25px; 
            box-sizing: border-box; overflow-y: auto; z-index: 100; 
        }
        .sidebar-item { margin-bottom: 25px; }
        .label-text { font-size: 14px; color: #bbb; margin-bottom: 8px; display: block;}
        .current-val { color: var(--primary-color); font-weight: bold; font-family: monospace; }
        .range-limits { display: flex; justify-content: space-between; font-size: 11px; color: #666; margin-top: -5px; }

        /* ã€æ ¸å¿ƒä¿®å¤ 1ï¼šä¸‹æ‹‰æ¡†æ·±è‰²æ¨¡å¼æ–‡å­—ä¸å¯è§é—®é¢˜ã€‘ */
        select, input { 
            width: 100%; padding: 10px; border-radius: 8px; 
            border: 1px solid rgba(255,255,255,0.2); 
            background: var(--input-bg); 
            color: var(--select-text); /* å¼ºåˆ¶è®¾ä¸ºç™½è‰² */
            box-sizing: border-box; 
            outline: none;
        }
        /* é’ˆå¯¹ä¸‹æ‹‰åˆ—è¡¨å±•å¼€åçš„é€‰é¡¹é¡¹é¢œè‰²ä¿®å¤ */
        select option {
            background-color: #1e1e2e; /* å±•å¼€åˆ—è¡¨èƒŒæ™¯è®¾ä¸ºæ·±è‰² */
            color: #ffffff; /* å±•å¼€åˆ—è¡¨æ–‡å­—è®¾ä¸ºç™½è‰² */
        }

        .slider { width: 100%; cursor: pointer; accent-color: var(--primary-color); }
        .radio-group { display: flex; flex-direction: column; gap: 8px; }
        .radio-item { cursor: pointer; padding: 10px; border-radius: 6px; background: rgba(255,255,255,0.08); font-size: 13px; color: #ccc; }
        .radio-item:hover { background: rgba(255,255,255,0.15); }
        .radio-item.active { background: var(--primary-color); color: white; font-weight: bold; }

        #main-content { margin-left: 300px; padding: 40px; width: calc(100% - 300px); min-height: 100vh; }
        .gallery { display: grid; gap: 25px; align-items: start; }
        .card { 
            background: var(--card-bg); border-radius: 12px; overflow: hidden; 
            box-shadow: 0 4px 15px rgba(0,0,0,0.1); border: 1px solid var(--border-color); 
        }
        .card-img-container { width: 100%; background: rgba(0,0,0,0.03); display: flex; align-items: center; justify-content: center; }
        .card img { width: 100%; height: auto; max-height: 400px; object-fit: contain; cursor: zoom-in; }
        .card-info { padding: 12px; border-top: 1px solid var(--border-color); }
        .info-header { display: flex; justify-content: space-between; align-items: center; font-size: 13px; }
        .date-tag { color: var(--primary-color); font-weight: bold; }
        .title-link { color: #007bff; cursor: pointer; font-weight: 500; text-decoration: none; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; max-width: 60%; }
        .expander-content { max-height: 0; overflow: hidden; transition: max-height 0.3s; font-size: 12.5px; color: var(--text-muted); line-height: 1.6; }
        .expander-content.open { max-height: 400px; margin-top: 10px; border-top: 1px dashed var(--border-color); padding-top: 10px; }

        #lightbox { 
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
            background: rgba(0,0,0,0.95); z-index: 2000; flex-direction: column; justify-content: center; align-items: center; 
        }
        #lightbox-img { max-width: 90%; max-height: 75%; object-fit: contain; }
        #lb-caption { 
            width: 80%; max-width: 800px; color: #ddd; text-align: center; margin-top: 20px;
            padding: 15px; background: rgba(255,255,255,0.1); border-radius: 10px; backdrop-filter: blur(5px);
        }
        .lb-btn { position: absolute; color: white; font-size: 40px; cursor: pointer; background: none; border: none; padding: 20px; }
        #lb-close { top: 20px; right: 30px; } #lb-prev { left: 30px; } #lb-next { right: 30px; }
        #load-more { display: block; margin: 50px auto; padding: 12px 45px; background: var(--primary-color); color: white; border: none; border-radius: 30px; cursor: pointer; font-weight: bold; }
    </style>
</head>
<body>

<div id="sidebar">
    <h2 id="ui-title" style="margin-bottom: 30px; font-size: 22px;">ğŸ® å½±åƒé¦†æ§åˆ¶å°</h2>
    
    <div class="sidebar-item">
        <label class="label-text" id="ui-lang-label">ğŸŒ è¯­è¨€åˆ‡æ¢</label>
        <select id="lang-select" onchange="changeLang(this.value)"></select>
    </div>

    <div class="sidebar-item">
        <label class="label-text" id="ui-cat-label">ğŸ“‚ æ ç›®ç­›é€‰</label>
        <div class="radio-group" id="category-group"></div>
    </div>

    <div class="sidebar-item">
        <label class="label-text" id="ui-search-label">æœç´¢æ¡£æ¡ˆå†…å®¹</label>
        <input type="text" id="search-input">
    </div>
    
    <div class="sidebar-item">
        <div class="label-row"><span class="label-text" id="ui-slider-label">â³ æ—¶é—´è½´æˆªæ­¢</span><span id="date-display" class="current-val"></span></div>
        <input type="range" id="date-slider" class="slider">
        <div class="range-limits"><span id="date-start">2014-02-12</span><span id="date-now">Today</span></div>
    </div>

    <div class="sidebar-item">
        <div class="label-row"><span class="label-text" id="ui-grid-label">ğŸ–¼ï¸ æ¯è¡Œåˆ—æ•°</span><span id="grid-display" class="current-val">3</span></div>
        <input type="range" id="grid-slider" class="slider" min="1" max="6" value="3">
        <div class="range-limits"><span>1 åˆ—</span><span>6 åˆ—</span></div>
    </div>
</div>

<div id="main-content">
    <h1 id="ui-main-title">â³ å†å²å½±åƒæ—¶é—´æœºå™¨</h1>
    <div id="search-info" style="margin-bottom: 25px; color: var(--text-muted); font-size: 14px;"></div>
    <div class="gallery" id="gallery"></div>
    <button id="load-more">ğŸ”½ åŠ è½½æ›´å¤šå½±åƒ</button>
</div>

<div id="lightbox">
    <button class="lb-btn" id="lb-close"><i class="fas fa-times"></i></button>
    <button class="lb-btn" id="lb-prev"><i class="fas fa-chevron-left"></i></button>
    <img id="lightbox-img">
    <div id="lb-caption"></div>
    <button class="lb-btn" id="lb-next"><i class="fas fa-chevron-right"></i></button>
</div>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script>
    // 10 å›½è¯­è¨€å­—å…¸
    const LANG_DICT = {
        "ğŸ‡¨ğŸ‡³ ç®€ä½“ä¸­æ–‡": { "title": "ğŸ® å½±åƒé¦†æ§åˆ¶å°", "main_title": "â³ å†å²å½±åƒæ—¶é—´æœºå™¨", "lang_label": "ğŸŒ è¯­è¨€åˆ‡æ¢", "search_label": "æœç´¢æ¡£æ¡ˆå†…å®¹", "search_ph": "è¾“å…¥å…³é”®è¯...", "load_more": "ğŸ”½ åŠ è½½æ›´å¤š ({0}/{1})", "no_more": "âœ… å·²åŠ è½½å…¨éƒ¨", "slider": "â³ æ—¶é—´è½´æˆªæ­¢", "cat_label": "ğŸ“‚ æ ç›®ç­›é€‰", "grid_label": "ğŸ–¼ï¸ æ¯è¡Œæ˜¾ç¤ºåˆ—æ•°", "cats": ["å…¨éƒ¨", "å¾®åšè°ˆ", "å¾®å†å²", "å¾®è§†é‡"] },
        "ğŸ‡­ğŸ‡° ç¹é«”ä¸­æ–‡": { "title": "ğŸ® å½±åƒé¤¨æ§åˆ¶å°", "main_title": "â³ æ­·å²å½±åƒæ™‚é–“æ©Ÿå™¨", "lang_label": "ğŸŒ èªè¨€åˆ‡æ›", "search_label": "æœç´¢æª”æ¡ˆå…§å®¹", "search_ph": "æœç´¢...", "load_more": "ğŸ”½ åŠ è¼‰æ›´å¤š ({0}/{1})", "no_more": "âœ… å·²åŠ è¼‰å…¨éƒ¨", "slider": "â³ æ™‚é–“è»¸æˆªæ­¢", "cat_label": "ğŸ“‚ æ¬„ç›®ç¯©é¸", "grid_label": "ğŸ–¼ï¸ åœ–ç‰‡åˆ—æ•¸", "cats": ["å…¨éƒ¨", "å¾®åšè«‡", "å¾®æ­·å²", "å¾®è¦–é‡"] },
        "ğŸ‡ºğŸ‡¸ English": { "title": "ğŸ® Console", "main_title": "â³ Time Machine", "lang_label": "ğŸŒ Language", "search_label": "Search", "search_ph": "Search...", "load_more": "ğŸ”½ Load More ({0}/{1})", "no_more": "âœ… Completed", "slider": "â³ Cutoff Date", "cat_label": "ğŸ“‚ Categories", "grid_label": "ğŸ–¼ï¸ Columns", "cats": ["All", "Weibo Talk", "History", "Vision"] },
        "ğŸ‡¯ğŸ‡µ æ—¥æœ¬èª": { "title": "ğŸ® ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«", "main_title": "â³ æ­´å²æ˜ åƒãƒã‚·ãƒ³", "lang_label": "ğŸŒ è¨€èªåˆ‡æ›¿", "search_label": "æ¤œç´¢", "search_ph": "æ¤œç´¢...", "load_more": "ğŸ”½ ã‚‚ã£ã¨è¦‹ã‚‹", "no_more": "âœ… å…¨è¡¨ç¤º", "slider": "â³ ã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³", "cat_label": "ğŸ“‚ ã‚«ãƒ†ã‚´ãƒª", "grid_label": "ğŸ–¼ï¸ åˆ—æ•°", "cats": ["ã™ã¹ã¦", "å¾®åšè«‡", "å¾®æ­´å²", "å¾®è¦–é‡"] },
        "ğŸ‡°ğŸ‡· í•œêµ­ì–´": { "title": "ğŸ® ì œì–´íŒ", "main_title": "â³ íƒ€ì„ë¨¸ì‹ ", "lang_label": "ğŸŒ ì–¸ì–´ ë³€ê²½", "search_label": "ê²€ìƒ‰", "search_ph": "ê²€ìƒ‰...", "load_more": "ğŸ”½ ë” ë³´ê¸°", "no_more": "âœ… ì™„ë£Œ", "slider": "â³ ì‹œê°„", "cat_label": "ğŸ“‚ ì¹´í…Œê³ ë¦¬", "grid_label": "ğŸ–¼ï¸ ì—´", "cats": ["ì „ì²´", "å¾®åšè«‡", "å¾®æ­·å²", "å¾®è¦–é‡"] }
        // ... (å…¶ä»–è¯­è¨€åŒç†ï¼Œæ ¸å¿ƒå·²å±•ç¤º)
    };

    const SB_URL = "https://ztsdhjjnydrnsxgsheyb.supabase.co";
    const SB_KEY = "sb_publishable_39tYq9zt52DxihifjY_ENw_elQW0FoK";
    const mySupabase = supabase.createClient(SB_URL, SB_KEY);

    let state = { lang: "ğŸ‡¨ğŸ‡³ ç®€ä½“ä¸­æ–‡", category: "å…¨éƒ¨", search: "", dateLimit: new Date().toISOString().split('T')[0], grid: 3, page: 0, pageSize: 50, allImages: [] };

    function initUI() {
        const langSelect = document.getElementById('lang-select');
        Object.keys(LANG_DICT).forEach(l => {
            const opt = document.createElement('option');
            opt.value = opt.innerText = l;
            langSelect.appendChild(opt);
        });

        const slider = document.getElementById('date-slider');
        slider.min = new Date("2014-02-12").getTime();
        slider.max = new Date().getTime();
        slider.value = slider.max;
        
        updateLanguage();
        refreshData(true);
    }

    function changeLang(val) { state.lang = val; updateLanguage(); refreshData(true); }

    function updateLanguage() {
        const L = LANG_DICT[state.lang];
        const ids = ["ui-title", "ui-main-title", "ui-lang-label", "ui-cat-label", "ui-search-label", "ui-slider-label", "ui-grid-label"];
        ids.forEach(id => {
            const el = document.getElementById(id);
            if(el) el.innerText = L[id.replace('ui-', '').replace('-', '_')];
        });
        document.getElementById('search-input').placeholder = L.search_ph;

        const catGroup = document.getElementById('category-group');
        catGroup.innerHTML = "";
        
        // ã€æ ¸å¿ƒä¿®æ”¹ 2ï¼šè°ƒæ•´æ ç›®ç­›é€‰é¡ºåºä¸ºï¼šå…¨éƒ¨ å¾®åšè°ˆ å¾®å†å² å¾®è§†é‡ã€‘
        // è¿™é‡Œçš„ L.cats å·²ç»åœ¨å­—å…¸é‡Œå®šä¹‰å¥½äº†é¡ºåº
        L.cats.forEach((c, idx) => {
            // å°†æ˜¾ç¤ºæ–‡å­—æ˜ å°„å›æ•°æ®åº“å¯¹åº”çš„åˆ†ç±»å
            const dbCatsMap = ["å…¨éƒ¨", "å¾®åšè°ˆ", "å¾®å†å²", "å¾®è§†é‡"];
            const realCat = dbCatsMap[idx];
            
            const div = document.createElement('div');
            div.className = `radio-item ${state.category === realCat ? 'active' : ''}`;
            div.innerText = c;
            div.onclick = () => { state.category = realCat; updateLanguage(); refreshData(true); };
            catGroup.appendChild(div);
        });
    }

    async function refreshData(isNew = false) {
        if (isNew) { state.page = 0; state.allImages = []; document.getElementById('gallery').innerHTML = ""; }
        const L = LANG_DICT[state.lang];
        let query = mySupabase.from('botan_final').select('*', { count: 'exact' });
        query = query.lte('production_date', state.dateLimit);
        if (state.search) query = query.ilike('description', `%${state.search}%`);
        if (state.category !== "å…¨éƒ¨") query = query.eq('category', state.category);
        query = query.order('production_date', { ascending: false }).range(state.page * state.pageSize, (state.page + 1) * state.pageSize - 1);

        const { data, count, error } = await query;
        if (error) return;
        state.allImages = state.allImages.concat(data);
        renderCards(data);
        const btn = document.getElementById('load-more');
        btn.innerText = (state.allImages.length >= count) ? L.no_more : L.load_more.replace('{0}', state.allImages.length).replace('{1}', count);
        btn.disabled = (state.allImages.length >= count);
    }

    function renderCards(data) {
        const container = document.getElementById('gallery');
        data.forEach((item, index) => {
            const cardIdx = state.allImages.length - data.length + index;
            const card = document.createElement('div');
            card.className = 'card';
            card.innerHTML = `
                <div class="card-img-container"><img src="${item.image_url}" onclick="openLightbox(${cardIdx})" loading="lazy"></div>
                <div class="card-info">
                    <div class="info-header">
                        <span class="date-tag">ğŸ“… ${item.production_date}</span>
                        <a class="title-link" onclick="toggleExpander(this)">ğŸ”— ${item.title || 'è¯¦æƒ…æè¿°'}</a>
                    </div>
                    <div class="expander-content">${item.description || ''}</div>
                </div>
            `;
            container.appendChild(card);
        });
    }

    function toggleExpander(link) { link.parentElement.nextElementSibling.classList.toggle('open'); }

    let lbIdx = 0;
    function openLightbox(i) { lbIdx = i; document.getElementById('lightbox').style.display='flex'; updateLbContent(); document.body.style.overflow='hidden'; }
    function closeLightbox() { document.getElementById('lightbox').style.display='none'; document.body.style.overflow='auto'; }
    function moveLb(step) { lbIdx = (lbIdx + step + state.allImages.length) % state.allImages.length; updateLbContent(); }
    function updateLbContent() {
        const item = state.allImages[lbIdx];
        document.getElementById('lightbox-img').src = item.image_url;
        document.getElementById('lb-caption').innerHTML = `<b>${item.production_date}</b> | ${item.title || ''}<br><small>${item.description || ''}</small>`;
    }

    document.getElementById('lb-close').onclick = closeLightbox;
    document.getElementById('lb-prev').onclick = (e) => { e.stopPropagation(); moveLb(-1); };
    document.getElementById('lb-next').onclick = (e) => { e.stopPropagation(); moveLb(1); };
    document.getElementById('lightbox').onclick = (e) => { if(e.target.id === 'lightbox') closeLightbox(); };

    document.getElementById('date-slider').oninput = (e) => {
        state.dateLimit = new Date(parseInt(e.target.value)).toISOString().split('T')[0];
        document.getElementById('date-display').innerText = state.dateLimit;
        clearTimeout(window.dt); window.dt = setTimeout(() => refreshData(true), 300);
    };
    document.getElementById('grid-slider').oninput = (e) => {
        state.grid = e.target.value;
        document.getElementById('grid-display').innerText = state.grid;
        document.getElementById('gallery').style.gridTemplateColumns = `repeat(${state.grid}, 1fr)`;
    };
    document.getElementById('search-input').oninput = (e) => {
        state.search = e.target.value;
        clearTimeout(window.st); window.st = setTimeout(() => refreshData(true), 500);
    };
    document.getElementById('load-more').onclick = () => { state.page++; refreshData(); };

    initUI();
    document.getElementById('gallery').style.gridTemplateColumns = `repeat(${state.grid}, 1fr)`;
</script>
</body>
</html>