<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>åšè°ˆå½±åƒæ¡£æ¡ˆåº“ V55-PRO</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        :root { --primary-color: #ff4b4b; --sidebar-bg: #1e1e2e; }
        body { font-family: "Segoe UI", "Microsoft YaHei", sans-serif; background-color: #f4f4f9; margin: 0; display: flex; overflow-x: hidden; }
        
        /* ä¾§è¾¹æ  */
        #sidebar { width: 300px; background: var(--sidebar-bg); color: white; height: 100vh; position: fixed; padding: 25px; box-sizing: border-box; overflow-y: auto; z-index: 100; }
        .sidebar-item { margin-bottom: 25px; }
        label { display: block; margin-bottom: 8px; font-size: 14px; color: #bbb; }
        
        /* ä¸»å†…å®¹ */
        #main-content { margin-left: 300px; padding: 40px; width: calc(100% - 300px); min-height: 100vh; }
        .stats-card { background: rgba(255,255,255,0.05); padding: 15px; border-radius: 10px; text-align: center; margin: 15px 0; }
        #total-count { font-size: 28px; font-weight: bold; color: var(--primary-color); display: block; }

        /* UI ç»„ä»¶ */
        select, input, .slider { width: 100%; padding: 10px; border-radius: 8px; border: none; margin-bottom: 10px; box-sizing: border-box; }
        .slider { cursor: pointer; accent-color: var(--primary-color); }
        .radio-group { display: flex; flex-direction: column; gap: 8px; }
        .radio-item { cursor: pointer; padding: 10px; border-radius: 6px; background: rgba(255,255,255,0.08); font-size: 13px; }
        .radio-item.active { background: var(--primary-color); color: white; }

        /* å½±åƒç½‘æ ¼ - è§£å†³å›¾ç‰‡å˜å½¢çš„å…³é”® */
        .gallery { display: grid; gap: 25px; transition: all 0.3s ease; }
        .card { background: white; border-radius: 12px; overflow: hidden; box-shadow: 0 4px 15px rgba(0,0,0,0.05); display: flex; flex-direction: column; }
        
        /* åŠ¨æ€å›¾ç‰‡é«˜åº¦ï¼šé€šè¿‡ object-fit ç¡®ä¿ä¸å˜å½¢ */
        .card img { 
            width: 100%; 
            aspect-ratio: 16 / 10; /* é”å®šé»„é‡‘æ¯”ä¾‹ */
            object-fit: cover; /* è‡ªåŠ¨è£åˆ‡å¡«å……è€Œä¸æ‹‰ä¼¸å˜å½¢ */
            background: #eee; 
            cursor: zoom-in;
            transition: opacity 0.3s;
        }
        .card img:hover { opacity: 0.9; }

        /* è¯¦æƒ…æŠ˜å åŒº */
        .card-info { padding: 12px; border-top: 1px solid #f0f0f0; }
        .expander-header { 
            display: flex; justify-content: space-between; align-items: center; 
            cursor: pointer; color: #444; font-size: 13px; font-weight: bold; 
        }
        .expander-content { 
            max-height: 0; overflow: hidden; transition: max-height 0.3s ease-out; 
            font-size: 12.5px; color: #666; line-height: 1.6; margin-top: 0;
        }
        .expander-content.open { max-height: 200px; margin-top: 10px; padding-bottom: 5px; }
        .card-date { color: var(--primary-color); margin-right: 5px; }

        /* å…¨å±ç¯ç®±æ ·å¼ */
        #lightbox {
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.95); z-index: 2000; justify-content: center; align-items: center;
        }
        #lightbox-img { max-width: 90%; max-height: 90%; object-fit: contain; box-shadow: 0 0 30px rgba(0,0,0,0.5); }
        .lb-btn { 
            position: absolute; color: white; font-size: 40px; cursor: pointer; 
            background: none; border: none; padding: 20px; transition: 0.3s;
        }
        .lb-btn:hover { color: var(--primary-color); }
        #lb-close { top: 20px; right: 30px; }
        #lb-prev { left: 30px; }
        #lb-next { right: 30px; }

        #load-more { display: block; margin: 50px auto; padding: 12px 45px; background: var(--primary-color); color: white; border: none; border-radius: 30px; cursor: pointer; font-weight: bold; }
        #load-more:disabled { background: #ccc; }
    </style>
</head>
<body>

<div id="sidebar">
    <h2 id="ui-title">ğŸ® å½±åƒé¦†æ§åˆ¶å°</h2>
    <div class="sidebar-item"><label id="ui-lang-label">ğŸŒ è¯­è¨€</label><select id="lang-select"></select></div>
    <div id="ui-flags" style="font-size: 18px; margin-bottom: 20px; letter-spacing: 5px;"></div>
    <div class="stats-card"><span id="ui-stats-label">ğŸ“Š æ€»è®¡</span><span id="total-count">...</span><small id="ui-unit">å·</small></div>
    <hr>
    <div class="sidebar-item"><label id="ui-cat-label">ğŸ“‚ æ ç›®</label><div class="radio-group" id="category-group"></div></div>
    <div class="sidebar-item"><label id="ui-search-label">æœç´¢</label><input type="text" id="search-input"></div>
    <div class="sidebar-item"><label id="ui-slider-label">â³ æ—¶é—´</label><input type="range" id="date-slider" class="slider"><div id="date-display" style="text-align: center; color: var(--primary-color); font-weight: bold;"></div></div>
    <div class="sidebar-item"><label id="ui-grid-label">ğŸ–¼ï¸ åˆ—æ•°</label><input type="range" id="grid-slider" class="slider" min="1" max="6" value="3"></div>
</div>

<div id="main-content">
    <h1 id="ui-main-title">â³ å†å²å½±åƒæ—¶é—´æœºå™¨</h1>
    <div id="search-info" style="margin-bottom: 25px; color: #777; font-size: 14px;"></div>
    <div class="gallery" id="gallery"></div>
    <button id="load-more">ğŸ”½ åŠ è½½æ›´å¤š</button>
</div>

<div id="lightbox">
    <button class="lb-btn" id="lb-close"><i class="fas fa-times"></i></button>
    <button class="lb-btn" id="lb-prev"><i class="fas fa-chevron-left"></i></button>
    <img id="lightbox-img" src="">
    <button class="lb-btn" id="lb-next"><i class="fas fa-chevron-right"></i></button>
</div>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script>
    // è¯­è¨€åŒ…ä¿æŒä¸å˜ (æ­¤å¤„ä¸ºç®€å†™ï¼Œå®é™…è¯·ä¿ç•™ä¹‹å‰å®Œæ•´çš„10å›½å­—å…¸)
    const LANG_DICT = {
        "ğŸ‡¨ğŸ‡³ ç®€ä½“ä¸­æ–‡": { "title": "ğŸ® å½±åƒé¦†æ§åˆ¶å°", "main_title": "â³ å†å²å½±åƒæ—¶é—´æœºå™¨", "lang_label": "ğŸŒ è¯­è¨€åˆ‡æ¢", "stats_label": "ğŸ“Š å…¨é¦†å½±åƒæ€»è®¡", "unit": "å·", "total_found": "ğŸ” åœ¨ {1} ä¹‹å‰æ£€ç´¢åˆ° {0} å·å½±åƒ", "search_label": "æœç´¢æ¡£æ¡ˆå†…å®¹", "search_ph": "è¾“å…¥å…³é”®è¯...", "load_more": "ğŸ”½ åŠ è½½æ›´å¤šå½±åƒ ({0}/{1})", "no_more": "âœ… å·²æ˜¾ç¤ºå…¨éƒ¨å†…å®¹", "slider": "â³ æ—¶é—´è½´æˆªæ­¢æ—¥æœŸ", "cat_label": "ğŸ“‚ æ ç›®ç­›é€‰", "all": "å…¨éƒ¨", "no_data": "ğŸ“­ æš‚æ— å½±åƒ", "grid_label": "ğŸ–¼ï¸ æ¯è¡Œæ˜¾ç¤ºå›¾ç‰‡æ•°", "flags": "ğŸ‡¨ğŸ‡³ ğŸ‡­ğŸ‡° ğŸ‡¹ğŸ‡­ ğŸ‡®ğŸ‡· ğŸ‡ºğŸ‡¸ ğŸ‡¯ğŸ‡µ ğŸ‡°ğŸ‡· ğŸ‡©ğŸ‡ª ğŸ‡«ğŸ‡· ğŸ‡»ğŸ‡³", "cats": ["å…¨éƒ¨", "å¾®åšè°ˆ", "å¾®è§†é‡", "å¾®å†å²"], "detail": "ğŸ“„ æŸ¥çœ‹è¯¦æƒ…" },
        "ğŸ‡ºğŸ‡¸ English": { "title": "ğŸ® Console", "main_title": "â³ Time Machine", "lang_label": "ğŸŒ Language", "stats_label": "ğŸ“Š Total", "unit": "Items", "total_found": "ğŸ” Found {0} items before {1}", "search_label": "Search", "search_ph": "Keywords...", "load_more": "ğŸ”½ Load More ({0}/{1})", "no_more": "âœ… All Loaded", "slider": "â³ Timeline", "cat_label": "ğŸ“‚ Category", "all": "All", "no_data": "ğŸ“­ No data", "grid_label": "ğŸ–¼ï¸ Columns", "flags": "ğŸ‡ºğŸ‡¸ ğŸ‡¬ğŸ‡§", "cats": ["All", "å¾®åšè°ˆ", "å¾®è§†é‡", "å¾®å†å²"], "detail": "ğŸ“„ View Details" }
        // ... è¯·åœ¨æ­¤å¤„è¡¥å……å…¶ä»– 8 å›½è¯­è¨€ ...
    };

    const SB_URL = "https://ztsdhjjnydrnsxgsheyb.supabase.co";
    const SB_KEY = "sb_publishable_39tYq9zt52DxihifjY_ENw_elQW0FoK";
    const mySupabase = supabase.createClient(SB_URL, SB_KEY);

    let state = { lang: "ğŸ‡¨ğŸ‡³ ç®€ä½“ä¸­æ–‡", category: "å…¨éƒ¨", search: "", dateLimit: new Date().toISOString().split('T')[0], grid: 3, page: 0, pageSize: 50, allImages: [] };

    // --- åˆå§‹åŒ– UI ---
    function initUI() {
        const langSelect = document.getElementById('lang-select');
        Object.keys(LANG_DICT).forEach(l => {
            const opt = document.createElement('option');
            opt.value = opt.innerText = l;
            langSelect.appendChild(opt);
        });
        const slider = document.getElementById('date-slider');
        slider.min = new Date("2014-02-12").getTime();
        slider.max = new Date().getTime();
        slider.value = slider.max;
        updateLanguage();
        fetchGlobalTotal();
        refreshData(true);
    }

    function updateLanguage() {
        const L = LANG_DICT[state.lang];
        document.getElementById('ui-title').innerText = L.title;
        document.getElementById('ui-main-title').innerText = L.main_title;
        document.getElementById('ui-lang-label').innerText = L.lang_label;
        document.getElementById('ui-stats-label').innerText = L.stats_label;
        document.getElementById('ui-unit').innerText = L.unit;
        document.getElementById('ui-cat-label').innerText = L.cat_label;
        document.getElementById('ui-search-label').innerText = L.search_label;
        document.getElementById('search-input').placeholder = L.search_ph;
        document.getElementById('ui-slider-label').innerText = L.slider;
        document.getElementById('ui-grid-label').innerText = L.grid_label;
        document.getElementById('ui-flags').innerText = L.flags;

        const catGroup = document.getElementById('category-group');
        catGroup.innerHTML = "";
        L.cats.forEach((c, idx) => {
            const realCat = (idx === 0) ? "å…¨éƒ¨" : ["å¾®åšè°ˆ", "å¾®è§†é‡", "å¾®å†å²"][idx-1];
            const div = document.createElement('div');
            div.className = `radio-item ${state.category === realCat ? 'active' : ''}`;
            div.innerText = c;
            div.onclick = () => { state.category = realCat; updateLanguage(); refreshData(true); };
            catGroup.appendChild(div);
        });
    }

    async function fetchGlobalTotal() {
        const { count } = await mySupabase.from('botan_final').select('*', { count: 'exact', head: true });
        document.getElementById('total-count').innerText = count.toLocaleString();
    }

    async function refreshData(isNew = false) {
        if (isNew) { state.page = 0; state.allImages = []; document.getElementById('gallery').innerHTML = ""; }
        const L = LANG_DICT[state.lang];
        let query = mySupabase.from('botan_final').select('*', { count: 'exact' });
        query = query.lte('production_date', state.dateLimit);
        if (state.search) query = query.ilike('description', `%${state.search}%`);
        if (state.category !== "å…¨éƒ¨") query = query.eq('category', state.category);
        query = query.order('production_date', { ascending: false }).range(state.page * state.pageSize, (state.page + 1) * state.pageSize - 1);

        const { data, count, error } = await query;
        if (error) return;
        state.allImages = state.allImages.concat(data);
        document.getElementById('search-info').innerText = L.total_found.replace('{0}', count).replace('{1}', state.dateLimit);
        renderCards(data);
        const loaded = document.querySelectorAll('.card').length;
        document.getElementById('load-more').innerText = (loaded >= count) ? L.no_more : L.load_more.replace('{0}', loaded).replace('{1}', count);
        document.getElementById('load-more').disabled = (loaded >= count);
    }

    function renderCards(data) {
        const container = document.getElementById('gallery');
        const L = LANG_DICT[state.lang];
        data.forEach((item, index) => {
            const cardIdx = state.allImages.length - data.length + index;
            const card = document.createElement('div');
            card.className = 'card';
            card.innerHTML = `
                <img src="${item.image_url}" onclick="openLightbox(${cardIdx})" loading="lazy">
                <div class="card-info">
                    <div class="expander-header" onclick="toggleExpander(this)">
                        <span><span class="card-date">ğŸ“… ${item.production_date}</span></span>
                        <i class="fas fa-chevron-down"></i>
                    </div>
                    <div class="expander-content">
                        ${item.description || '...'}
                    </div>
                </div>
            `;
            container.appendChild(card);
        });
    }

    // --- é€»è¾‘æ§åˆ¶ ---
    function toggleExpander(header) {
        const content = header.nextElementSibling;
        const icon = header.querySelector('i');
        content.classList.toggle('open');
        icon.style.transform = content.classList.contains('open') ? 'rotate(180deg)' : 'rotate(0deg)';
    }

    // --- ç¯ç®±ç”»å»Šé€»è¾‘ ---
    let currentLbIdx = 0;
    function openLightbox(idx) {
        currentLbIdx = idx;
        document.getElementById('lightbox').style.display = 'flex';
        document.getElementById('lightbox-img').src = state.allImages[idx].image_url;
        document.body.style.overflow = 'hidden'; // ç¦æ­¢èƒŒæ™¯æ»šåŠ¨
    }

    function closeLightbox() {
        document.getElementById('lightbox').style.display = 'none';
        document.body.style.overflow = 'auto';
    }

    function changeLbImage(step) {
        currentLbIdx += step;
        if (currentLbIdx < 0) currentLbIdx = state.allImages.length - 1;
        if (currentLbIdx >= state.allImages.length) currentLbIdx = 0;
        document.getElementById('lightbox-img').src = state.allImages[currentLbIdx].image_url;
    }

    // --- äº‹ä»¶ç›‘å¬ ---
    document.getElementById('lb-close').onclick = closeLightbox;
    document.getElementById('lb-prev').onclick = () => changeLbImage(-1);
    document.getElementById('lb-next').onclick = () => changeLbImage(1);
    document.getElementById('lightbox').onclick = (e) => { if(e.target.id === 'lightbox') closeLightbox(); };
    
    // é”®ç›˜æ”¯æŒ
    window.onkeydown = (e) => {
        if (document.getElementById('lightbox').style.display === 'flex') {
            if (e.key === 'ArrowLeft') changeLbImage(-1);
            if (e.key === 'ArrowRight') changeLbImage(1);
            if (e.key === 'Escape') closeLightbox();
        }
    };

    document.getElementById('lang-select').onchange = (e) => { state.lang = e.target.value; updateLanguage(); refreshData(true); };
    document.getElementById('search-input').oninput = (e) => {
        clearTimeout(window.stimer);
        window.stimer = setTimeout(() => { state.search = e.target.value; refreshData(true); }, 500);
    };
    document.getElementById('date-slider').oninput = (e) => {
        state.dateLimit = new Date(parseInt(e.target.value)).toISOString().split('T')[0];
        document.getElementById('date-display').innerText = state.dateLimit;
        clearTimeout(window.dtimer);
        window.dtimer = setTimeout(() => refreshData(true), 300);
    };
    document.getElementById('grid-slider').oninput = (e) => {
        state.grid = e.target.value;
        document.getElementById('gallery').style.gridTemplateColumns = `repeat(${state.grid}, 1fr)`;
    };
    document.getElementById('load-more').onclick = () => { state.page++; refreshData(); };

    initUI();
    document.getElementById('gallery').style.gridTemplateColumns = `repeat(${state.grid}, 1fr)`;
    document.getElementById('date-display').innerText = state.dateLimit;
</script>
</body>
</html>